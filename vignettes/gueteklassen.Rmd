---
title: "public transit service quality"
date: "`r Sys.Date()`"
author: "Flavio Poletti"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Public Transit Quality (ÖV-Güteklassen)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(rmarkdown.html_vignette.check_title = FALSE)
library(tidytransit)
library(dplyr)
library(sf)
library(mapview)
```

# Datensatz

https://opentransportdata.swiss/de/dataset/timetable-2021-gtfs2020

Download Datensatz
Auszug erstellen
Weiterarbeit mit Auszug (wäre auch mit Gesamtdatensatz möglich)

```{r Load}
gtfs_path = system.file("extdata", "gtfs_ch_zg.zip",  package = "tidytransit")
g = read_gtfs(gtfs_path)
```
# Vorgehen

### Ausschnitt
```{r Subset, echo=F}
stops = g$stops %>% 
  group_by(stop_name) %>%
  summarise(stop_lon = mean(stop_lon), stop_lat = mean(stop_lat)) %>% 
  stops_as_sf(2056)
```

### Art der Verkehrsmittel
```{r Verkehrsmittel}
stop_times = filter_stop_times(g, "2021-06-30", "06:00:00", "20:00:00") %>% as_tibble()

stop_times <- stop_times %>% 
  select(stop_id, trip_id, arrival_time, departure_time) %>% 
  inner_join(g$stops[c("stop_id", "stop_name")], "stop_id") %>% 
  inner_join(g$trips[c("trip_id", "route_id")], "trip_id") %>% 
  inner_join(g$routes[c("route_id", "route_type")], "route_id")

vmg = stop_times %>% 
  select(route_type) %>% unique() %>%
  inner_join(tidytransit::route_type_names, "route_type") %>% 
  arrange(route_type)

vmg$Verkehrsmittelgruppe <- "B"
vmg$Verkehrsmittelgruppe[which(vmg$route_type %in% c(1,2,100:120,400:410))] <- "A"
vmg$Verkehrsmittelgruppe[which(vmg$route_type %in% c(6,7,1400))] <- "C"

stop_times <- stop_times %>%
  inner_join(vmg[c("route_type", "Verkehrsmittelgruppe")], "route_type")
```

### Bahnknoten/Bahnlinie
```{r Bahntypen}
bknoten_blinie = stop_times %>% 
  group_by(stop_name, Verkehrsmittelgruppe) %>% 
  summarise(n_routes = n_distinct(route_id), .groups = "drop")

bknoten_blinie$Verkehrsmittel <- bknoten_blinie$Verkehrsmittelgruppe
bknoten_blinie$Verkehrsmittel[which(bknoten_blinie$Verkehrsmittelgruppe == "A" & 
                                            bknoten_blinie$n_routes > 2)] <- "A1"
bknoten_blinie$Verkehrsmittel[which(bknoten_blinie$Verkehrsmittelgruppe == "A" & 
                                      bknoten_blinie$n_routes <= 2)] <- "A2"
bknoten_blinie$n_routes <- NULL

st_vm = stop_times %>% 
  inner_join(bknoten_blinie, c("stop_name", "Verkehrsmittelgruppe"))
```

### Kursintervall
```{r Kursintervall}
ARE_kursintervalle = c("< 5 Min.", ">=5 bis < 10 Min.", ">= 10 bis < 20 Min.",
                    ">= 20 bis < 40 Min.", ">= 40 bis <= 60 Min.")

st_vm_ki = st_vm %>% 
  filter(arrival_time >= hms::parse_hm("06:00")) %>%
  filter(arrival_time <= hms::parse_hm("20:00")) %>% 
  group_by(stop_name, Verkehrsmittel) %>% 
  count(name = "n_departures") %>% ungroup()

st_vm_ki <- st_vm_ki %>% 
  mutate(interval = (20-6)*60 / (n_departures/2)) %>% 
  mutate(Kursintervall = cut(interval, c(0, 5, 10, 20, 40, 60), 
                             right = F, labels = ARE_kursintervalle, 
                             ordered_result = T)) %>% 
  select(-interval, -n_departures)
```

### Haltestellenkategorie
```{r Haltestellenkategorie}
# TODO factor functions
ARE_haltestellenkategorie = tibble(
  Kursintervall = ARE_kursintervalle,
  A1 = c("I", "I", "II", "III", "IV"),
  A2 = c("I", "II", "III", "IV", "V"),
  B = c("II", "III", "IV", "V", "V"),
  C = c("V", "V", "V", "V", "V"))
ARE_haltestellenkategorie <- ARE_haltestellenkategorie %>%
  tidyr::gather("Verkehrsmittel", "Haltestellenkategorie", -Kursintervall) %>% 
  mutate(Kursintervall = factor(Kursintervall, ARE_kursintervalle, ordered = T))

hskat = inner_join(st_vm_ki, ARE_haltestellenkategorie, c("Verkehrsmittel", "Kursintervall")) %>% 
  mutate(Verkehrsmittel = factor(Verkehrsmittel, c("A1", "A2", "B", "C"), ordered = TRUE)) %>% 
  mutate(Haltestellenkategorie = factor(Haltestellenkategorie,  c("I", "II", "III", "IV", "V"), ordered = TRUE))
```

### Distanz zur Haltestelle
```{r Distanz}
ARE_gueteklasse_tbl = tibble(
  Haltestellenkategorie = c("I", "II", "III", "IV", "V"),
  "< 300 m" = c("A", "A", "B", "C", "D"),
  "300 - 500 m" = c("A", "B", "C", "D", "keine"),
  "501 - 750 m" = c("B", "C", "D", "keine", "keine"),
  "751 - 1000 m" = c("C", "D", "keine", "keine", "keine"))
ARE_gueteklasse <- ARE_gueteklasse_tbl %>%
  tidyr::gather("Distanz", "Gueteklasse", -Haltestellenkategorie) %>% 
  filter(Gueteklasse != "keine") %>% 
  mutate(Haltestellenkategorie = factor(Haltestellenkategorie, c("I", "II", "III", "IV", "V"), ordered = TRUE)) %>% 
  mutate(Gueteklasse = factor(Gueteklasse, c("A", "B", "C", "D"), ordered = TRUE)) %>% 
  mutate(Distanz = factor(Distanz, c("< 300 m", "300 - 500 m", "501 - 750 m", "751 - 1000 m"), ordered = TRUE))

distance_num = tibble(Distanz = levels(ARE_gueteklasse$Distanz),
                      distance = c(300, 500, 750, 1000))
```

### ÖV-Güteklasse
```{r Gueteklasse, out.width="100%"}
stop_dist = stops %>% 
  inner_join(hskat, "stop_name") %>%
  inner_join(ARE_gueteklasse, "Haltestellenkategorie") %>% 
  inner_join(distance_num, "Distanz") %>% 
  filter(Gueteklasse != "keine")
  
gueteklassen_buffer = st_buffer(stop_dist, stop_dist$distance)

gueteklassen_buffer %>% arrange(desc(Gueteklasse)) %>% select(Gueteklasse) %>% plot()

gueteklassen <- gueteklassen_buffer %>% 
  select(Gueteklasse) %>% 
  group_by(Gueteklasse) %>% 
  summarise() %>% 
  arrange(Gueteklasse) %>% 
  st_difference()
```

## Map

```{r Map, out.width="100%"}
mapview(gueteklassen, layer.name = "Güteklasse")
```