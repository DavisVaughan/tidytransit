=---
title: "Introduction to Transit Service Mapping"
author: "Tom Buckley"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tidytransit-headways}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(tidytransit)
```

# Introduction

The focus of this vignette is on how to use R to estimate where and how frequently transit service operates, based on a common transit data standard (GTFS). 

# Audience & Background

We imagine the typical users of this tutorial to be public servants and citizens that want to understand GTFS and transit frequency estimation in more depth than is covered in the reference and the introduction. 

The inspiration for these tools was California's Senate Bill 50, which aimed to increase housing supply adjacent to 'high frequency transit', as demonstrated in [this graphic by Alfred Twu](https://www.dropbox.com/s/rk7oxy67gyego8l/SB50-zones-2019-05-08.pdf?dl=0):

![SB 50 - Housing and Transit](https://cdn.vox-cdn.com/uploads/chorus_asset/file/16233546/SB50_zones_2019_05_08_page_001.jpg "SB 50 - Housing and Transit")

# GTFS and Transit Frequency and Location

GTFS feeds were designed to let transit agencies publish their schedules and locations of service to their passengers. Therefore, they can be used to try to derive summaries of where and when transit operates. While this process is not always neat, there are a few techniques that you can use and we've tried to capture some of those here. 

# Read a GTFS File

First, read the GTFS file of interest in. 

For this example, we read the NYC Subway map included in this package. (Note: you can use any GTFS. A list of feeds can be found in a data frame [called feedlist](http://tidytransit.r-transit.org/reference/feedlist.html), which is loaded into your R Environment when you load the package.)

```{r}
# nyc <- read_gtfs("http://web.mta.info/developers/data/nyct/subway/google_transit.zip")

local_gtfs_path <- system.file("extdata", 
                               "google_transit_nyc_subway.zip", 
                               package = "tidytransit")
nyc <- read_gtfs(local_gtfs_path)
```

# Service ID's

Before identifying where and when transit operates, it is necessary to identify a schedule of service of interest. In the interst of demonstrating how to use the frequency estimation functions in the package, we'll use a simple heuristic to estimate the most frequent service, in this case the service_id with the most trips associated with it.  

```{r}
most_frequent_service <- nyc$trips %>%
  top_n(1, service_trips)
```

In some cases, this heuristic is a fast way to identify the most frequent transit service in a feed. But the usefulness of this heuristic is tempered by variations in how schedules of service, identified in GTFS by a 'service_id', are flexibly used by transit agencies. For example, the heuristic [fails on the Barcelona subway GTFS feed](https://github.com/r-transit/tidytransit/issues/72), where each 'line' in the subway has a unique schedule identifier. So for Barcelona, on a given 'monday' service, you might have as many 'service_id's as there are lines on the subway. 

You should read [the service patterns vignette](http://tidytransit.r-transit.org/articles/servicepatterns.html) to help you identify a service_id (or set of service_id's) that represent the services you want to understand. 

Remember to keep the service schedule in mind as you develop frequency and headway estimations. The schedule of service interacts with key assumptions you might make about frequency calculation, such as the time period that you're calculating frequency for. 

# get_route_frequency()
 
You can use `get_route_frequency` to estimate frequencies along a given transit line for a given service_id and time frame. The method for this function is very simple. `get_route_frequency` counts the number of times vehicles pass through stops along the route and then divides that by the period length of the start and end time. The, it creates an r summary table for the stops along each route and outputs a data frame representing the estimated frequency of service along all stops for that route, for the specified time period and service schedule. 

```{r}
nyc$.$frequency_df <- get_route_frequency(nyc, 
                                          service_ids = most_frequent_service, 
                                          start_hour = 6, 
                                          end_hour = 20)
```

Lets take a look at what that data frame looks like for NYC. 

```{r}
head(nyc$.$routes_frequency)
```

One way we can verify these estimates is by checking against reported headways. 

For example, we see that our estimated median headway for the 1 train from 6 AM to 10 PM is 5 minutes. When we compare this estimate with the [wikipedia entry](https://en.wikipedia.org/wiki/List_of_New_York_City_Subway_services#Train_intervals) for this train, we have a rough match. Headways reported there are 3 minutes at rush hour, 6 minutes at mid-day and 10 minutes at night. 

# Frequencies on Specific Days and Times

You might be interested in calculating headways for more specific times of day. 

For example, what are rush hour headways like on a specific weekday (2018-08-23)? The `set_hms_times` and `set_date_service_table` functions will alter the feed for us, allowing us to filter by date. 

```{r}
nyc <- nyc %>% 
  set_hms_times() %>% 
  set_date_service_table()
```

Below we pull a service ID for a specific weekday (2018-08-23). 

```{r}
nyc <- nyc %>% 
  set_hms_times() %>% 
  set_date_service_table()

services_on_180823 <- nyc$.$date_service_table %>% 
  filter(date == "2018-08-23") %>% select(service_id)
```

See the `servicepatterns` and `timetable` vignettes for more advice on schedule filtering.

Then we calculate the route frequency in the afternoon rush hour. 

```{r}
nyc <- get_route_frequency(nyc, service_id = services_on_180823, start_hour = 16, end_hour = 19)
```

```{r}
head(nyc$.$routes_frequency)
```

Again, the median headways for the 1 train seem to roughly correspond (1 min off) to those published on [wikipedia entry](https://en.wikipedia.org/wiki/List_of_New_York_City_Subway_services#Train_intervals)
